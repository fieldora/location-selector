<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapbox Location Picker</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css' type='text/css' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .mapboxgl-ctrl-geocoder--error {
            display: none !important;
        }
        #status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 500;
            z-index: 9999;
            display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .success {
            background-color: #4CAF50;
            color: white;
        }
        .error {
            background-color: #F44336;
            color: white;
        }
        .loading {
            background-color: #2196F3;
            color: white;
        }
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 600px) {
            .mapboxgl-ctrl-geocoder {
                min-width: 200px;
                width: calc(100% - 80px);
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>
    <div id='map'></div>
    <div id='status-message'></div>

    <script>
        // Helper functions
        function showStatus(message, type = 'success', duration = 3000) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = type;
            statusElement.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, duration);
            }
            
            return statusElement;
        }
        
        function isValidCoordinate(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) && 
                   lat >= -90 && lat <= 90 && 
                   lng >= -180 && lng <= 180;
        }

        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Get required parameters
                const urlParams = new URLSearchParams(window.location.search);
                const mapboxToken = urlParams.get('mapboxToken');
                const glideToken = urlParams.get('glideToken');
                const appId = urlParams.get('appId');
                const tableId = urlParams.get('tableId');
                const rowId = urlParams.get('rowId');
                const columnName = urlParams.get('columnName');
                
                // Validate required parameters
                if (!mapboxToken || !glideToken || !appId || !tableId || !rowId || !columnName) {
                    throw new Error('Missing required parameters');
                }
                
                // Initialize map
                mapboxgl.accessToken = mapboxToken;
                
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/satellite-streets-v11',
                    center: [-95, 37],
                    zoom: 4
                });
                
                // Add navigation controls
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                
                // Initialize geocoder
                const geocoder = new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    mapboxgl: mapboxgl,
                    placeholder: 'Search for an address or enter coordinates (lat,lng)',
                    marker: false
                });
                
                map.addControl(geocoder, 'top-left');
                
                let marker;
                
                // Handle map events
                map.on('load', function() {
                    document.getElementById('loading-overlay').style.display = 'none';
                    
                    // Add user location control with error handling
                    const geolocateControl = new mapboxgl.GeolocateControl({
                        positionOptions: {
                            enableHighAccuracy: true,
                            timeout: 15000  // 15 second timeout for location acquisition
                        },
                        trackUserLocation: false,
                        showUserLocation: true,
                        showAccuracyCircle: true
                    });
                    
                    map.addControl(geolocateControl, 'top-right');
                    
                    // Add error handling for geolocation
                    geolocateControl.on('error', (e) => {
                        let errorMsg = 'Unable to determine your location';
                        
                        if (e.code === 1) { // PERMISSION_DENIED
                            errorMsg = 'Location access denied. Please enable location services.';
                        } else if (e.code === 2) { // POSITION_UNAVAILABLE
                            errorMsg = 'Your location is currently unavailable.';
                        } else if (e.code === 3) { // TIMEOUT
                            errorMsg = 'Location request timed out. Please try again.';
                        }
                        
                        showStatus(errorMsg, 'error');
                    });
                    
                    // Handle successful geolocation
                    geolocateControl.on('geolocate', (position) => {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // Add marker at user's location when geolocated
                        addOrUpdateMarker(longitude, latitude);
                        debouncedUpdate(latitude, longitude);
                    });
                });
                
                // Debounce function to limit API calls
                const debounce = (func, delay) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), delay);
                    };
                };
                
                // Add marker to map
                function addOrUpdateMarker(longitude, latitude) {
                    if (marker) {
                        marker.remove();
                    }

                    marker = new mapboxgl.Marker({
                        draggable: true,
                        color: '#3880ff'
                    })
                    .setLngLat([longitude, latitude])
                    .addTo(map);
                    
                    // Update coordinates when marker is dragged
                    marker.on('dragend', function() {
                        const lngLat = marker.getLngLat();
                        debouncedUpdate(lngLat.lat, lngLat.lng);
                    });
                }

                // Update coordinates in Glide table
                function updateGlideTableCoordinates(latitude, longitude) {
                    if (!isValidCoordinate(latitude, longitude)) {
                        showStatus('Invalid coordinates', 'error');
                        return;
                    }
                    
                    const loadingStatus = showStatus('Updating coordinates...', 'loading', 0);
                    
                    const endpoint = 'https://api.glideapp.io/api/function/mutateTables';
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${glideToken}`
                    };

                    const data = {
                        appID: appId,
                        mutations: [
                            {
                                kind: "set-columns-in-row",
                                tableName: tableId,
                                columnValues: {
                                    [columnName]: `${latitude},${longitude}`
                                },
                                rowID: rowId
                            }
                        ]
                    };
                    
                    fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`${response.status} ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(() => {
                        loadingStatus.style.display = 'none';
                        showStatus('Location updated successfully', 'success');
                    })
                    .catch(error => {
                        loadingStatus.style.display = 'none';
                        showStatus(`Error updating location: ${error.message}`, 'error');
                        console.error('Error updating data:', error);
                    });
                }
                
                // Create debounced update function
                const debouncedUpdate = debounce(updateGlideTableCoordinates, 500);

                // Map click handler
                map.on('click', function(e) {
                    const latitude = e.lngLat.lat;
                    const longitude = e.lngLat.lng;

                    addOrUpdateMarker(longitude, latitude);
                    debouncedUpdate(latitude, longitude);
                });

                // Geocoder result handler
                geocoder.on('result', function(e) {
                    const latitude = e.result.geometry.coordinates[1];
                    const longitude = e.result.geometry.coordinates[0];

                    addOrUpdateMarker(longitude, latitude);
                    debouncedUpdate(latitude, longitude);
                });

                // Direct coordinate entry support
                const geocoderInput = document.querySelector('.mapboxgl-ctrl-geocoder--input');
                if (geocoderInput) {
                    geocoderInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            const val = this.value.trim();
                            const coordPattern = /^\s*([-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)),\s*([-+]?(180(\.0+)?|((1[0-7]\d(\.\d+)?)|([1-9]?\d(\.\d+)?))))\s*$/;
                            const match = val.match(coordPattern);
                            
                            if (match) {
                                const latitude = parseFloat(match[1]);
                                const longitude = parseFloat(match[5]);
                                
                                map.flyTo({
                                    center: [longitude, latitude],
                                    zoom: 15
                                });
                                
                                addOrUpdateMarker(longitude, latitude);
                                debouncedUpdate(latitude, longitude);
                                
                                e.preventDefault();
                            }
                        }
                    });
                }
                
                // Clean up resources when page is unloaded
                window.addEventListener('beforeunload', function() {
                    if (map) {
                        map.remove();
                    }
                });
                
            } catch (error) {
                document.getElementById('loading-overlay').innerHTML = 
                    `<div style="text-align: center; padding: 20px;">
                        <h3>Error Initializing Map</h3>
                        <p>${error.message}</p>
                        <button onclick="location.reload()">Reload Page</button>
                    </div>`;
                console.error('Initialization error:', error);
            }
        });
    </script>
</body>
</html>
